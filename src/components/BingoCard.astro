---
import QRCode from 'qrcode';

interface Props {
  items: string[];
  cardNumber: number;
  title?: string;
  titleAccessories?: {
    top?: string;
    bottom?: string;
  };
  description?: string;
  qrCodeUrl?: string;
}

const { 
  items, 
  cardNumber, 
  title = "Bingo",
  titleAccessories = {
    top: "Großeltern",
    bottom: "Frühvergreiste Edition"
  },
  description = "Oma fragt schon wieder, ob du genug isst? Opa erzählt zum 100. Mal die gleiche Geschichte? Wenn du eine Reihe oder Diagonale voll hast, ruf laut \"Bingo!\" und verteile 4 Shots.",
  qrCodeUrl
} = Astro.props;

const gridItems = items;

// Generate QR code as data URL if URL is provided
let qrCodeDataUrl: string | null = null;
let jokerIndex: number | null = null;

if (qrCodeUrl) {
  qrCodeDataUrl = await QRCode.toDataURL(qrCodeUrl, {
    width: 120,
    margin: 0,
    color: {
      dark: '#000000',
      light: '#ffffff'
    }
  });
  // Random position for QR code joker (0-15 for 4x4 grid)
  jokerIndex = Math.floor(Math.random() * 16);
}
---

<div class="font-serif w-full h-full p-6 bg-white">
  <div class="h-full border border-black rounded-2xl p-6 flex flex-col justify-between bg-white relative overflow-visible">
    
    <!-- Name field in bottom right corner -->
    <div class="absolute -bottom-px right-4 bg-white px-2 flex items-end gap-2">
      <span class="text-[9px] text-black uppercase tracking-wide leading-none translate-y-[1px]">Name:</span>
      <div class="w-36 border-b border-dashed border-black"></div>
    </div>

    <!-- Header -->
    <div class="text-center mt-4">
      <!-- Decorative divider above -->
      <div class="flex items-center justify-center gap-3 mb-3 max-w-[280px] mx-auto relative">
        <div class="h-px bg-black absolute inset-x-0 top-1/2"></div>
        {titleAccessories?.top && (
          <span class="text-[10px] tracking-[0.2em] uppercase bg-white px-2 z-10">{titleAccessories.top}</span>
        )}
      </div>
      
      <h1 class="text-4xl text-black tracking-wide uppercase">{title}</h1>
      
      <!-- Decorative divider below -->
      <div class="flex items-center justify-center gap-3 mt-3 max-w-[280px] mx-auto relative">
        <div class="h-px bg-black absolute inset-x-0 top-1/2"></div>
        {titleAccessories?.bottom && (
          <span class="text-[10px] tracking-[0.2em] uppercase bg-white px-2 z-10">{titleAccessories.bottom}</span>
        )}
      </div>
    </div>

    <!-- Description -->
    <div class="text-center">
      <p class="text-xs text-black max-w-[85%] mx-auto leading-relaxed text-pretty italic">
        {description}
      </p>
    </div>

    <!-- Bingo Grid -->
    <div class="bingo-grid mx-auto w-full">
      <div class="aspect-square grid grid-cols-4 grid-rows-4 gap-2">
        {gridItems.map((item, index) => (
          index === jokerIndex && qrCodeDataUrl ? (
            <div 
              class="aspect-square relative flex items-center justify-center text-center p-1 bg-white border border-black"
            >
              <img src={qrCodeDataUrl} alt="QR Code Joker" class="w-[85%] h-auto object-contain" />
              <span class="absolute -bottom-[5px] left-1/2 -translate-x-1/2 bg-white px-1 text-[7px] uppercase tracking-wider font-semibold">Joker</span>
            </div>
          ) : (
            <div 
              class="aspect-square flex items-center justify-center text-center p-2 bg-white border border-black text-[11px] leading-tight text-black"
            >
              <span class="break-words hyphens-auto">{item}</span>
            </div>
          )
        ))}
      </div>
    </div>

  </div>
</div>

<style>
  .bingo-card {
    box-sizing: border-box;
  }
</style>
